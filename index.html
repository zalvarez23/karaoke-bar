<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/kantobar-icon.svg" />
    <link rel="apple-touch-icon" href="/kantobar-icon.svg" />
    <link rel="manifest" href="/manifest.json" />

    <!-- Apple Touch Icons para iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="/kantobar-icon.svg" />
    <link rel="apple-touch-icon" sizes="152x152" href="/kantobar-icon.svg" />
    <link rel="apple-touch-icon" sizes="144x144" href="/kantobar-icon.svg" />
    <link rel="apple-touch-icon" sizes="120x120" href="/kantobar-icon.svg" />
    <link rel="apple-touch-icon" sizes="114x114" href="/kantobar-icon.svg" />
    <link rel="apple-touch-icon" sizes="76x76" href="/kantobar-icon.svg" />
    <link rel="apple-touch-icon" sizes="72x72" href="/kantobar-icon.svg" />
    <link rel="apple-touch-icon" sizes="60x60" href="/kantobar-icon.svg" />
    <link rel="apple-touch-icon" sizes="57x57" href="/kantobar-icon.svg" />
    <link rel="apple-touch-icon" href="/kantobar-icon.svg" />
    <meta name="theme-color" content="#191720" />
    <meta name="msapplication-navbutton-color" content="#191720" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />

    <!-- Configuraci√≥n m√°s agresiva para iOS -->
    <meta name="apple-mobile-web-app-orientations" content="portrait" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-title" content="KantoBar" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, minimal-ui"
    />
    <meta
      name="theme-color"
      content="#191720"
      media="(prefers-color-scheme: dark)"
    />
    <title>KantoBar</title>
  </head>
  <body>
    <div id="root"></div>
    <script>
      // Ocultar UI del navegador en m√≥vil
      if (window.innerHeight <= window.innerWidth) {
        // Landscape mode - ocultar barras
        window.addEventListener("load", function () {
          setTimeout(function () {
            window.scrollTo(0, 1);
          }, 0);
        });
      }

      // Prevenir zoom en doble tap
      let lastTouchEnd = 0;
      document.addEventListener(
        "touchend",
        function (event) {
          const now = new Date().getTime();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        },
        false
      );

      // Registrar Service Worker para PWA
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker
            .register("/sw.js")
            .then(function (registration) {
              console.log(
                "‚úÖ Service Worker registrado exitosamente:",
                registration.scope
              );

              // Verificar actualizaciones cada vez que se carga la p√°gina
              registration.update();

              // Forzar actualizaci√≥n cada 30 segundos si la p√°gina est√° activa
              setInterval(() => {
                if (!document.hidden) {
                  registration.update();
                }
              }, 30000);

              // Escuchar actualizaciones del service worker
              registration.addEventListener("updatefound", () => {
                console.log("üîÑ Nueva versi√≥n del Service Worker encontrada");
                const newWorker = registration.installing;

                if (newWorker) {
                  newWorker.addEventListener("statechange", () => {
                    if (
                      newWorker.state === "installed" &&
                      navigator.serviceWorker.controller
                    ) {
                      console.log(
                        "‚úÖ Nueva versi√≥n instalada y lista para activar"
                      );
                      // La notificaci√≥n se mostrar√° autom√°ticamente via el hook
                    }
                  });
                }
              });
            })
            .catch(function (error) {
              console.log("‚ùå Error al registrar Service Worker:", error);
            });
        });
      }

      // Prevenir bounce scroll en iOS pero permitir scroll normal
      document.addEventListener(
        "touchstart",
        function (e) {
          const target = e.target;
          const scrollableElement =
            target.closest("[data-scrollable]") ||
            target.closest(".scrollable") ||
            document.body;
          if (scrollableElement) {
            scrollableElement.style.overflow = "auto";
            scrollableElement.style.webkitOverflowScrolling = "touch";
          }
        },
        { passive: true }
      );

      // Prevenir gesture indicator desde abajo en iOS
      let startY = 0;
      document.addEventListener(
        "touchstart",
        function (e) {
          startY = e.touches[0].clientY;
        },
        { passive: true }
      );

      document.addEventListener(
        "touchmove",
        function (e) {
          const currentY = e.touches[0].clientY;
          const deltaY = startY - currentY;

          // Si el touch empez√≥ desde abajo y se mueve hacia arriba, prevenir
          if (startY > window.innerHeight - 100 && deltaY > 0) {
            e.preventDefault();
          }
        },
        { passive: false }
      );

      // Ocultar home indicator en iOS de forma m√°s agresiva
      if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        // Forzar que el viewport use toda la pantalla
        document.documentElement.style.setProperty(
          "--vh",
          `${window.innerHeight * 0.01}px`
        );

        // Prevenir que aparezca el home indicator
        document.addEventListener("touchstart", function () {}, {
          passive: true,
        });

        // Ocultar la barra de navegaci√≥n del sistema
        if (window.navigator && window.navigator.standalone !== undefined) {
          document.body.style.paddingBottom = "0px";
          document.body.style.marginBottom = "0px";
        }
      }
    </script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
